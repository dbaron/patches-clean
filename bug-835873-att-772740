# HG changeset patch
# Parent 04d8c309fe728f61d5a48122bf5706c6f86da209
# User Bear Travis <betravis@adobe.com>
Bug 835873 - Misalignment when using min-height compared to height
This patch calculates the desired height before the button content's vertical offset is determined.

diff --git a/layout/forms/nsHTMLButtonControlFrame.cpp b/layout/forms/nsHTMLButtonControlFrame.cpp
--- a/layout/forms/nsHTMLButtonControlFrame.cpp
+++ b/layout/forms/nsHTMLButtonControlFrame.cpp
@@ -204,32 +204,16 @@ nsHTMLButtonControlFrame::Reflow(nsPresC
   nsMargin focusPadding = mRenderer.GetAddedButtonBorderAndPadding();
   
   // Reflow the contents of the button.
   ReflowButtonContents(aPresContext, aDesiredSize, aReflowState, firstKid,
                        focusPadding, aStatus);
 
   aDesiredSize.width = aReflowState.ComputedWidth();
 
-  // If computed use the computed value.
-  if (aReflowState.ComputedHeight() != NS_INTRINSICSIZE) {
-    aDesiredSize.height = aReflowState.ComputedHeight();
-  } else {
-    aDesiredSize.height += focusPadding.TopBottom();
-
-    // Make sure we obey min/max-height in the case when we're doing intrinsic
-    // sizing (we get it for free when we have a non-intrinsic
-    // aReflowState.ComputedHeight()).  Note that we do this before adjusting
-    // for borderpadding, since mComputedMaxHeight and mComputedMinHeight are
-    // content heights.
-    aDesiredSize.height = NS_CSS_MINMAX(aDesiredSize.height,
-                                        aReflowState.mComputedMinHeight,
-                                        aReflowState.mComputedMaxHeight);
-  }
-
   aDesiredSize.width += aReflowState.mComputedBorderPadding.LeftRight();
   aDesiredSize.height += aReflowState.mComputedBorderPadding.TopBottom();
 
   aDesiredSize.ascent +=
     aReflowState.mComputedBorderPadding.top + focusPadding.top;
 
   aDesiredSize.SetOverflowAreasToDesiredBounds();
   ConsiderChildOverflow(aDesiredSize.mOverflowAreas, firstKid);
@@ -284,16 +268,32 @@ nsHTMLButtonControlFrame::ReflowButtonCo
               0, aStatus);
   
   // calculate the min internal height so the contents gets centered correctly.
   // XXXbz this assumes border-box sizing.
   nscoord minInternalHeight = aReflowState.mComputedMinHeight -
     aReflowState.mComputedBorderPadding.TopBottom();
   minInternalHeight = std::max(minInternalHeight, 0);
 
+  // If computed use the computed value.
+  if (aReflowState.ComputedHeight() != NS_INTRINSICSIZE) {
+    aDesiredSize.height = aReflowState.ComputedHeight();
+  } else {
+    aDesiredSize.height += aFocusPadding.TopBottom();
+
+    // Make sure we obey min/max-height in the case when we're doing intrinsic
+    // sizing (we get it for free when we have a non-intrinsic
+    // aReflowState.ComputedHeight()).  Note that we do this before adjusting
+    // for borderpadding, since mComputedMaxHeight and mComputedMinHeight are
+    // content heights.
+    aDesiredSize.height = NS_CSS_MINMAX(aDesiredSize.height,
+                                        aReflowState.mComputedMinHeight,
+                                        aReflowState.mComputedMaxHeight);
+  }
+
   // center child vertically
   nscoord yoff = 0;
   if (aReflowState.ComputedHeight() != NS_INTRINSICSIZE) {
     yoff = (aReflowState.ComputedHeight() - aDesiredSize.height)/2;
     if (yoff < 0) {
       yoff = 0;
     }
   } else if (aDesiredSize.height < minInternalHeight) {
diff --git a/layout/reftests/forms/button/min-height-ref.html b/layout/reftests/forms/button/min-height-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/forms/button/min-height-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<meta http-equiv="content-type" content="text/html; charset=utf-8">
+<style>
+.btn1, .btn2 {
+    border: 5px solid green;
+    background-color: blue;
+    height: 50px;
+}
+</style>
+</head>
+<body>
+<input type='submit' class='btn1' value='' />
+<input type='submit' class='btn2' value='' />
+</body>
+</html>
\ No newline at end of file
diff --git a/layout/reftests/forms/button/min-height.html b/layout/reftests/forms/button/min-height.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/forms/button/min-height.html
@@ -0,0 +1,22 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+<meta http-equiv="content-type" content="text/html; charset=utf-8">
+<style>
+.btn1, .btn2 {
+    border: 5px solid green;
+    background-color: blue;
+}
+.btn1 {
+    min-height: 50px;
+}
+.btn2 {
+    height: 50px;
+}
+</style>
+</head>
+<body>
+<input type='submit' class='btn1' value='' />
+<input type='submit' class='btn2' value='' />
+</body>
+</html>
\ No newline at end of file
diff --git a/layout/reftests/forms/button/reftest.list b/layout/reftests/forms/button/reftest.list
--- a/layout/reftests/forms/button/reftest.list
+++ b/layout/reftests/forms/button/reftest.list
@@ -1,3 +1,4 @@
 asserts(2) == first-letter-1.html first-letter-1-ref.html
 asserts(1) != first-letter-1.html first-letter-1-noref.html
 == max-height.html max-height-ref.html
+== min-height.html min-height-ref.html
