From: Michael Ventnor <ventnor.bugzilla@gmail.com>

Use the correct area for 'background-position: fixed' gradients.  (Bug 509681)  r=roc

diff --git a/layout/base/nsCSSRendering.cpp b/layout/base/nsCSSRendering.cpp
--- a/layout/base/nsCSSRendering.cpp
+++ b/layout/base/nsCSSRendering.cpp
@@ -1958,20 +1958,16 @@ PaintBackgroundLayer(nsPresContext* aPre
       nsMargin padding = geometryFrame->GetUsedPadding();
       geometryFrame->ApplySkipSides(padding);
       bgPositioningArea.Deflate(padding);
       NS_ASSERTION(aLayer.mOrigin == NS_STYLE_BG_ORIGIN_CONTENT,
                    "unknown background-origin value");
     }
   }
 
-  nsSize imageSize = imageRenderer.ComputeSize(bgPositioningArea.Size());
-  if (imageSize.width <= 0 || imageSize.height <= 0)
-    return;
-
   // Compute the anchor point.
   //
   // relative to aBorderArea.TopLeft() (which is where the top-left
   // of aForFrame's border-box will be rendered)
   nsPoint imageTopLeft, anchor, offset;
   if (NS_STYLE_BG_ATTACHMENT_FIXED == aLayer.mAttachment) {
     // If it's a fixed background attachment, then the image is placed
     // relative to the viewport, which is the area of the root frame
@@ -2001,16 +1997,20 @@ PaintBackgroundLayer(nsPresContext* aPre
         bgPositioningArea.Deflate(scrollbars);
       }
     }
 
     offset = bgPositioningArea.TopLeft() - aForFrame->GetOffsetTo(topFrame);
   } else {
     offset = bgPositioningArea.TopLeft();
   }
+
+  nsSize imageSize = imageRenderer.ComputeSize(bgPositioningArea.Size());
+  if (imageSize.width <= 0 || imageSize.height <= 0)
+    return;
      
   // Scale the image as specified for background-size and as required for
   // proper background positioning when background-position is defined with
   // percentages.
   float scaleX, scaleY;
   switch (aLayer.mSize.mWidthType) {
     case nsStyleBackground::Size::eContain:
     case nsStyleBackground::Size::eCover: {
diff --git a/layout/reftests/css-gradients/linear-viewport-ref.html b/layout/reftests/css-gradients/linear-viewport-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-gradients/linear-viewport-ref.html
@@ -0,0 +1,1 @@
+<body style="border: 0; margin: 0; padding: 0;"><div style="background: -moz-linear-gradient(top, bottom, from(blue), to(aqua)) no-repeat; width: 100%; height: 100%;">&nbsp;</div></body>
diff --git a/layout/reftests/css-gradients/linear-viewport.html b/layout/reftests/css-gradients/linear-viewport.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-gradients/linear-viewport.html
@@ -0,0 +1,2 @@
+<!-- bug 509681 -->
+<body style="background: -moz-linear-gradient(top, bottom, from(blue), to(aqua)) fixed no-repeat;">
diff --git a/layout/reftests/css-gradients/reftest.list b/layout/reftests/css-gradients/reftest.list
--- a/layout/reftests/css-gradients/reftest.list
+++ b/layout/reftests/css-gradients/reftest.list
@@ -1,8 +1,9 @@
 == linear.html linear-ref.html
 == radial.html radial-ref.html
 == linear-keywords.html linear-keywords-ref.html
 == linear-percent.html linear-percent-ref.html
 == linear-mix.html linear-mix-ref.html
 == nostops.html nostops-ref.html
 == onestop.html onestop-ref.html
 == twostops.html twostops-ref.html
+== linear-viewport.html linear-viewport-ref.html
